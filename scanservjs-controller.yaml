substitutions:
  device_name: "scanservjs-controller"

esphome:
  name: ${device_name}

esp8266:
  board: d1_mini

<<: !include common/substitutions.yaml
packages:
  wifi: !include common/wifi.yaml
  mqtt: !include common/mqtt.yaml
  management: !include common/management.yaml

i2c:

font:
  - file: "fonts/Arial.ttf"
    id: arial12
    size: 12

# ---------------- GLOBAL STATE ----------------
globals:
  - id: scan_server
    type: std::string
    initial_value: '"http://scanservjs"'

  - id: dpi_str
    type: std::string
    initial_value: '"300"'

  - id: color_mode_str
    type: std::string
    initial_value: '"Gray"'

  - id: source_str
    type: std::string
    initial_value: '"Flatbed"'

  - id: flatbed_mode_str
    type: std::string
    initial_value: '"Single"'

  - id: adf_mode_str
    type: std::string
    initial_value: '"Simplex"'

  - id: status_str
    type: std::string
    initial_value: '""'

http_request:
  id: http_client
  useragent: ${device_name}
  verify_ssl: false
  timeout: 2min

# ---------------- DISPLAY ----------------
display:
  - platform: ssd1306_i2c
    id: oled
    model: "SSD1306 64x48"
    address: 0x3C

# ---------------- SELECTS ----------------
select:
  - platform: template
    id: dpi_select
    optimistic: true
    options: ["75","100","150","200","300","600","1200"]

  - platform: template
    id: color_select
    optimistic: true
    options: ["Lineart","Gray","Color"]

  - platform: template
    id: source_select
    optimistic: true
    options: ["Flatbed","ADF"]

  - platform: template
    id: flatbed_mode_select
    optimistic: true
    options: ["Single","Multi"]

  - platform: template
    id: adf_mode_select
    optimistic: true
    options: ["Simplex","Duplex"]

# ---------------- MENU ----------------
graphical_display_menu:
  id: scanner_menu
  display: oled
  font: arial12
  mode: rotary
  active: false

  items:
    # DPI
    - type: select
      text: "DPI"
      select: dpi_select
      on_value:
        then:
          - lambda: 'id(dpi_str) = it->get_value_text();'

    # Color
    - type: select
      text: "Color"
      select: color_select
      on_value:
        then:
          - lambda: 'id(color_mode_str) = it->get_value_text();'

    # Source
    - type: select
      text: "Source"
      select: source_select
      on_value:
        then:
          - lambda: 'id(source_str) = it->get_value_text();'

    # Flatbed mode (only meaningful if Flatbed)
    - type: select
      text: "Mode"
      select: flatbed_mode_select
      on_value:
        then:
          - lambda: |-
              if (id(source_str) == "Flatbed")
                id(flatbed_mode_str) = it->get_value_text();

    # ADF mode (only meaningful if ADF)
    - type: select
      text: "ADF Mode"
      select: adf_mode_select
      on_value:
        then:
          - lambda: |-
              if (id(source_str) == "ADF")
                id(adf_mode_str) = it->get_value_text();

    # Start scan command
    - type: command
      text: "Start Scan"
      on_value:
        then:
          - lambda: 'id(status_str) = "Scanning...";'

          - http_request.post:
              url: !lambda 'return id(scan_server) + "/api/v1/scan";'
              request_headers:
                Content-Type: application/json
              body: !lambda |-
                std::string json =
                  std::string("{\"params\":{") +
                  "\"resolution\":" + id(dpi_str) + "," +
                  "\"mode\":\"" + id(color_mode_str) + "\"," +
                  "\"source\":\"" + id(source_str) + "\"," +
                  "\"adfMode\":\"" +
                    (id(source_str) == "Flatbed"
                      ? id(flatbed_mode_str)
                      : id(adf_mode_str)) +
                  "\"},\"pipeline\":\"JPG | @:pipeline.high-quality\"}";
                return json;

              on_response:
                then:
                  - lambda: 'id(status_str) = "Scan done";'

              on_error:
                then:
                  - lambda: 'id(status_str) = "Scan failed";'

    - type: label
      text: !lambda 'return id(status_str);'

# ---------------- BUTTONS ----------------
binary_sensor:
  - platform: gpio
    pin: D3
    on_press:
      - if:
          condition:
            display_menu.is_active: scanner_menu
          then:
            - display_menu.up: scanner_menu

  - platform: gpio
    pin: D4
    on_press:
      - if:
          condition:
            display_menu.is_active: scanner_menu
          then:
            - display_menu.down: scanner_menu

  - platform: gpio
    pin: D5
    name: "Button Select"
    on_press:
      - if:
          condition:
            display_menu.is_active: scanner_menu
          then:
            - display_menu.enter: scanner_menu
          else:
            - display_menu.show: scanner_menu
